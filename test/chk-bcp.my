#!/bin/mysh

#include "ext.my"

#
# Header
#

do_init

proc check_tables( str P_TABLES, str P_DSQUERY) {

	str DBNAME, TABNAME, RES;
	int COUNT;

	printf "%40s" "Name  ";
	printf "%-10s" "File ";
	printf "%-10s" "Table ";
	echo;

	for TABLE in $P_TABLES
	do
		DBNAME=$(echo $TABLE|cut -d. -f1);
		TABNAME=$(echo $TABLE|cut -d. -f2);

		printf "%40s" "$TABLE: ";

		COUNT=$(wc -l ${BACKUP_DIR}/$P_DSQUERY-${TABNAME}.out|tr -s '[:space:]'|cut -d" " -f1);
		printf "%-10s" "$COUNT ";

		do_isql( "master", "select count(*) a from $DBNAME..$TABNAME");
		checkret( "$?", "Can't select count from table $TABLE", "nolog");

		RES=$(echo $RES|cut -d ":" -f3 |tr -d '[:space:]');
		printf "%-10s" "$RES ";

		echo;
	done
}

proc usage( str FULLNAME) {

	str NAME;

	NAME=$(basename $FULLNAME);

	echo "usage: $NAME [-e env][-u user][-v][-t] dataserver";
	echo "";
	echo " -v = verbose output";
	echo " -t = test mode";
	echo " -e = env to use (ie FSGDEV2-TST1)";
	echo " -u = database user to login as";
	echo "";

	exit( 1);
}

getopt "v,VERBOSE,e:,USE_ENV,u:,USE_USER,t,TESTMODE";

if [ $# -ne 1 ] then
	usage( $0);
fi

setdb( "$1", "$USE_USER");

get_envfile( "$TMPENV");

echo "Save Tables";
echo "---- ------";
check_tables( "${SAVE_TABLE}", "$DSQUERY");

echo "Save Data";
echo "---- ----";
check_tables( "${SAVE_DATA}", "$DSQUERY");

do_finish
