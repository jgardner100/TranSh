#!/bin/bash

#
# create.sh - create the tables used to record all database refresh details
#
# Author: John Gardner
# Date: 10 Dec 2010
#

do_init

proc check_exists( str P_TABLE) {

	str NAME;

	do_isql "wrapetc_prd" "
			select name from sysobjects where name='$P_TABLE'
	";
	checkret "$?" "Can't check status of $P_TABLE";
	NAME=$(echo $RES|tr -d [:space:]);
	if [ ! -z "$NAME" ] then
		echo "table $NAME exists";
		exit 1;
	else
		echo "no such table";
	fi
}

proc do_drop( str P_TABLE) {

	do_isql "wrapetc_prd" "drop table $P_TABLE";
	checkret "$?" "Failed to drop table $P_TABLE";
	display "$RES";
}

proc do_create( str P_TABLE, str P_CREATE) {

	do_isql "wrapetc_prd" "$P_CREATE";
	checkret "$?" "Can't create table $P_TABLE";
	display "$RES";
}

proc create_table( str P_TABLE, str P_CREATE) {

	check_exists "$P_TABLE";
	do_create "$P_TABLE" "$P_CREATE";
}

proc usage( str ARGV) {

	str NAME;

        NAME=$(basename $1);

        echo "usage: $NAME [-d]";
	echo "";
        echo " -d = drop tables";

	exit 1;
}

getopt "c,CHECK,d,DROP,v,VERBOSE";

if [ $# -ne 0 ] then
        usage $0;
fi

setdb FSGDEV11;

if [ ! -z "$DROP" ] then
	do_drop "refresh_status";
	do_drop "refresh_log";
	do_drop "refresh_error";

	exit 0;
elif [ ! -z "$CHECK" ] then

	check_exists "refresh_status";
	check_exists "refresh_log";
	check_exists "refresh_error";

	exit 0;
fi

create_table "refresh_status" "

	create table refresh_status (
		dsquery varchar(30)
	        ,status varchar(30)
	        ,start datetime
	        ,stop datetime null
	)

";

create_table "refresh_log" "

	create table refresh_log (
		dsquery varchar(30)
		,process varchar(30)
		,status varchar(30)
		,start datetime
		,stop datetime null
	)
";

create_table "refresh_error" "

	create table refresh_error (
		dsquery varchar(30)
		,process varchar(30)
		,ts_stamp datetime
		,message varchar(255) null
	)
";

do_finish
