#!/bin/mysh

#include "ext.my"

#
# all-space.sh - Check the space used by each table in a database
#
# Author: John Gardner
# Date: 1 June 2010
#

do_init

proc all_tables( str P_DB) {

	str TABLES;

	do_isql( "$P_DB", "select name from sysobjects where type = 'U'");
	TABLES="$RES";

	for TABLE in $TABLES
	do
		echo "$TABLE";
		do_isql( "$P_DB", "sp_spaceused $TABLE");
		display( "$RES");
	done
}

proc usage() {

	str NAME;

	NAME=$(basename $1);
	echo "usage: $NAME [-e env][-u user][-v][-d db] dataserver";
	echo "";
	echo " -v = verbose output";
        echo " -e = env to use (ie FSGDEV2-TST1)";
        echo " -u = database user to login as";
        echo " -d = database to do this for";
	echo "";

	exit 1;
}

getopt "u:,USE_USER,e:,USE_ENV,d:,DBARG,v,VERSION";

if [ $# -ne 1 ] then
	usage $0;
fi

setdb( "$1", $USE_USER);

get_envfile( "$TMPENV");

if [ ! -z "$DBARG" ] then
	all_tables( "$DBARG");
else
	for DB in $DB_LIST
	do
		all_tables( "$DB");
	done
fi

do_finish
