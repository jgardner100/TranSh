#!/bin/mysh

#include "ext.my"

#
# extchk.sh
#
# author: John Gardner
# date: 12/4/10
#
# Check for external logins in the database and list details.
#

global str EXTRN_PW;
global str RET;
global str SRVNAME;
global str EXTRN;
global str UNAME;

EXTRN_PW="<PASSWD>";

do_init

proc get_extern_logins() {

	do_isql( "master", "
		select
			'#'+convert(varchar(15),svr.srvname)+
			'#'+convert(varchar(20),name)+
			'#'+convert(varchar(20),object_cinfo)+
			'#'
		from
			sysattributes atr
			,sysservers svr
			,syslogins
		where
			object_type = 'EL'
			and object_info1 = srvid
			and object = suid
	");

	checkret( "$?", "Select external logins failed!", "nolog");

	RET=$(cat <<EOS|grep -v "\-\-\-"
$RES
EOS);
}

proc usage( str FULLNAME) {

	str NAME;

        NAME=$(basename FULLNAME);

        echo "$NAME: [-v][-e env][-u user] dataserver";
        echo "";
        echo "-v = verbose";
        echo "-u = env to use (ie FSGDEV2-TST1)";
        echo "-e = database user to login as";
	echo "";

        exit( 1);
}

getopt "v,VERBOSE,u:USE_USER,e,USE_ENV";
if [ "$#" -ne 1 ] then
        usage( $0);
fi

setdb( "$1", "$USEUSER");

get_extern_logins;

if [ -z "$RES" ] then
	echo "No external logins found";
else
	for ENTRY in $RET
	do
		SRVNAME=$(echo $ENTRY|cut -d# -f2);
		UNAME=$(echo $ENTRY|cut -d# -f3);
		EXTRN=$(echo $ENTRY|cut -d# -f4);

		echo "sp_addexternlogin '$SRVNAME','$NAME','$EXTRN','$EXTRN_PW'";
	done

fi

do_finish
