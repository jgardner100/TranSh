#!/bin/mysh

#include "ext.my"

#
# chk-procs.sh
#
# Author: John Gardner
# Date: 5 Jan 2011
#
# 	Compare the stored procs across two dataservers and report any
# differences.
#

do_init

global str TMPFILE1;
global str TMPFILE2;
global str PROCLIST;
global str SOURCE;
global str TARGET;

TMPFILE1="$TMPDIR/proc1.$$";
TMPFILE2="$TMPDIR/proc2.$$";

proc get_ddl( str P_DB, str P_PROCS) {

	for PROCN in $P_PROCS
	do
		echo $PROCN;
		setdb( "$SOURCE", $USE_USER);
		do_ddl( "$P_DB", "P", "$PROCN", "$TMPFILE1");
		do_filter( "$TMPFILE1", "create proc");

		setdb( "$TARGET", $USE_USER);
		do_ddl( "$P_DB", "P", "$PROCN", "$TMPFILE2");
		do_filter( "$TMPFILE2", "create proc");

		diff "$TMPFILE1" "$TMPFILE2";
	done
}

proc get_proclist( str P_DB) {

	do_isql( "$P_DB", "select name from sysobjects where type = 'P'");
	checkret( "$?", "Failed to select stored proc names in $P_DB", "nolog");

	PROCLIST="$RES";
}

proc usage( str ARGV) {

	str NAME;

        NAME=$(basename "$ARGV");

        echo "usage: $NAME [-t][-v][-d dbname] source-ds target-ds";
	echo "";
	echo " -t = Testmode, no changes to be made";
	echo " -v = Verbose output";
	echo " -d = Database name";

        exit(1);
}

getopt "t,TESTMODE,v,VERBOSE,d:,DATABASE,e:,USE_ENV,u:,USE_USER";

if [ $# -ne 2 ] then
        usage($0);
fi

if [ -z "$DATABASE" ] then
	echo "";
	echo "Must supply database name";
	echo "";
        usage($0);
fi

SOURCE="$1";
TARGET="$2";

setdb( "$SOURCE", $USE_USER);
get_proclist( "$DATABASE");

setdb( "$TARGET", $USE_USER);
get_ddl( "$DATABASE", "$PROCLIST");

rm -f "$TMPFILE1" "$TMPFILE2";

do_finish
