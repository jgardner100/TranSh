#!/bin/mysh

#include "ext.my"

global str TARGET;

#
# chk-procs.sh
#
# Author: John Gardner
# Date: 12 Oct 2016
#
# 	Compare the stored procs,views and permissions across two dataservers and report any
# differences.
#

do_init

proc list_stats_dates( str P_DB) {

	do_isql( "$P_DB", "SELECT MAX(moddate),s.id,convert(varchar(30),o.name)
				FROM sysstatistics s,sysobjects o
				WHERE s.id=o.id
				GROUP BY s.id,o.name
				ORDER BY o.name
	");
	checkret( "$?", "Failed to select stored proc names in $P_DB", "nolog");

	display( "$RES");
}

proc usage( str ARGV) {

	str NAME;

        NAME=$(basename "$ARGV");

        echo "usage: $NAME [-a][-t][-v][-d dbname] dataserver";
	echo "";
	echo " -a = all objects (procs, views) default is procs only";
	echo " -t = Testmode, no changes to be made";
	echo " -v = Verbose output";
	echo " -d = Database name";
	echo " -e = env to use (ie FSGDEV2-TST1)";
	echo " -u = database user to login as";

        exit(1);
}

getopt "a,DOALL,t,TESTMODE,v,VERBOSE,d:,DATABASE,u:,USE_USER,e:,USE_ENV";

if [ $# -ne 1 ] then
        usage( "$0");
fi

if [ -z "$DATABASE" ] then
	echo "";
	echo "Must supply database name";
	echo "";
        usage( "$0");
fi

TARGET="$1";

setdb( "$TARGET", $USE_USER);

list_stats_dates( "$DATABASE");

do_finish

exit(0);
