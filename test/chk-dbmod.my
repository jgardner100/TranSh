#!/bin/mysh

#include "ext.my"

#
# chk-dbmod.my
#
# Check all procs and views for prod references
#
# Author: John Gardner
# Date: 1 Feb 2017
#

global str ISQL_EXTRA;
global str DATASERVER;

do_init

ISQL_EXTRA=" -b";

proc show_dbmod( str P_DBNAME) {

	str RES;

	do_isql( "$P_DBNAME", "select distinct object_name(id) from syscomments where text like '%wrap_prd%' or text like '%amd_prd%' or text like '%WRPPROD%' or text like 'FSGPROD%'");
	checkret( "$?", " SQL failed!", "nolog");

	RES=$(echo $RES | cut -d":" -f2-);
	echo "The procs/views below in $P_DBNAME still contain references to PROD dbs";
	echo "************************************************";
	echo $RES;
}

proc usage( str FULLNAME) {

	str NAME;

	NAME=$(basename $FULLNAME);

	echo "$NAME : [-a][-v][-e env][-u user] dataserver";
	echo "";
	echo "-v = verbose output";
	echo "-e = env to use (ie FSGDEV2-TST1)";
	echo "-u = database user to login as";
	echo "-a = check all databases";
	echo "";

	exit( 1);
}

getopt "a,ALL_DB,u:,USE_USER,e:,USE_ENV,v,VERBOSE";

if [ $# -ne 1 ] then
	usage( $0);
fi

DATASERVER="$1";

setdb( "$DATASERVER", "$USE_USER");

get_envfile( "$TMPENV");
get_param( "$TMPENV", "DB_LIST");
for DATABASE in $DB_LIST
do
	show_dbmod( $DATABASE);
done

do_finish
