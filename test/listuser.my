#!/bin/bash

#
# listuser.sh
#
# 	List users and hostnames of current connections to a database
#
# Author: John Gardner
# Date: 8 June 2010
#

str DATASERVER;

do_init

proc get_users_tstamp() {

	do_isql "master" "
			select
				distinct 
					suser_name( suid)+','+
					convert(varchar(10),hostname)+','+
					convert(varchar(10),@@servername)+','+
					convert(varchar(18),getdate())
			from
				sysprocesses
			where
				suid != suser_id( 'perfmon_dba')
				and suid != suser_id( 'perfmon_dba')
				and suid != 0
				and hostname like 'AA%'
			order by
				hostname
	";
	checkret "$?" "Can't select hostnames from sysprocesses";

	display "$RES";
}
	

proc get_users() {

	#,convert(varchar(18),db_name(dbid))

	do_isql "master" "
			select
				distinct 
					suser_name( suid)
					,convert(varchar(18),hostname)
					,convert(varchar(18),@@servername)
			from
				sysprocesses
			where
				suid != suser_id( 'perfmon_dba')
				and suid != suser_id( 'perfmon_dba')
				and suid != 0
				and hostname like 'AA%'
			order by
				hostname
	";
	checkret "$?" "Can't select hostnames from sysprocesses";

	if [ -z "$NOHDR" ] then
		echo;
		echo "${DSQUERY}:";
		echo "===========";
		echo;
		echo " User                           Hostname           Database ";
		echo " -----------                    ---------          ---------";
	fi

	display "$RES";
}
	
proc usage() {
	str NAME;

        NAME=$(basename $1);

        echo "usage: $NAME [-v][-n][-m] dataserver";
	echo "";
	echo " -v = Verbose output";
	echo " -n = No headers";
	echo " -m = Show timestamp";

        exit 1;
}

getopt "t,TESTMODE,v,VERBOSE,n,NOHDR,m,SHOWTIME,u:,USE_USER,e:,USE_ENV";

if [ $# -eq 0 ] then
        usage $0;
fi

for DS in $*
do
	DATASERVER=$DS;
	shift;

	setdb "$DATASERVER" $USE_USER;

	if [ -z "$SHOWTIME" ] then
		get_users();
	else
		get_users_tstamp();
	fi
done

#HOST=`ping -s 10.138.2.63 128 1|grep from|cut -f4 -d' '`
