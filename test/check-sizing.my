#!/bin/mysh

#
# check-sizing
#
# Check database sizes prior to refresh
#
# Author: John Gardner
# Date: who knows?
#

#include "ext.my"

str DBLIST, LIST;

do_init

proc check_size( str P_DATABASE) {

	do_verbose( "Doing $P_DATABASE");

	do_verbose( "do_isql master sp_helpdb $P_DATABASE");
	do_isql( "master","sp_helpdb $P_DATABASE");
	checkret( "$?","failed to get database size for $P_DATABASE", "nolog");

	display("$RES");
}

proc usage() {

	str NAME;

        NAME=$(basename $1);

        echo "usage: $NAME [-v] dataserver";
	echo "";
	echo "-v = verbose output";

        exit(1);
}

getopt "e:,USE_ENV,u:,USE_USER,v,VERBOSE";

if [ $# -lt 1 ] then
        usage $0;
fi

DBLIST="$*";
for DS in $DBLIST
do

	setdb( "$DS", "$USE_USER");

	echo "${DSQUERY}:";

	get_envfile( "$TMPENV");

	LIST=$(echo "$DB_LIST"| tr -s "[:space:]" "[\n*]"|sort);

	for DB in $LIST
	do
		check_size( "$DB");
	done

	rm -f "$TMPFILE" "$TMPENV";

	echo "";
done

do_finish
