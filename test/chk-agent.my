#!/bin/mysh

#include "ext.my"

#
# chk-agent.my - Check that a rep agent is running
#
# Author: John Gardner
# Date:
#

do_init

proc check_agent( str P_DBNAME) {

	echo "Checking rep agent for $P_DBNAME";

	do_isql( "$P_DBNAME", "$P_DBNAME..sp_help_rep_agent $P_DBNAME,'process'");
	if [ "$?" -ne 0 ] then
		echo "No replication agent";
	else
		display( "$RES");
	fi
}

proc check_alldb() {

	get_envfile( "$TMPENV");
	get_param( "$TMPENV", "DB_LIST");

	for NAME in $PVAL
	do
		echo $NAME;
		check_agent( "$NAME");
	done

	rm -f "$TMPENV";
}

proc usage() {
	str NAME;

        NAME=$(basename $1);
        echo "usage: $NAME [-e env][-u user] dataserver";
        echo "-e = env to use (ie FSGDEV2-TST1)";
        echo "-u = database user to login as";
        exit 1;
}

getopt "u:,USE_USER,e:,USE_ENV,v,VERBOSE";

if [ $# -lt 1 ] then
        usage $0;
fi

for DS in $*
do

	setdb $DS $USE_USER;
	check_alldb();

done

do_finish
