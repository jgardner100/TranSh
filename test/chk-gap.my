#!/bin/bash

#
# chk-gap.sh
#
# Check the gap between composer and wrap shadow
#
# Author: John Gardner
# Date:
#

do_init

proc get_val( str P_DSNAME, str P_DBNAME, str P_QUERY) {

	setdb "$P_DSNAME";

	do_isql "$P_DBNAME" "$P_QUERY";

	display "$RES";
}

proc usage() {

	NAME=$(basename $1);
	echo "usage: $NAME [-v][-d] composer wrap";
	echo "";
	echo "-v = verbose output";
	echo "-e = env to use (ie FSGDEV2-TST1)";
	echo "-u = database user to login as";
	exit 1;
}

getopt "e:,USE_ENV,u:,USE_USER,v,VERBOSE";

if [ $# -ne 2 ] then
	usage $0;
fi

COMP="$1";
WRAP="$2";

setdb "$1" $USE_USER;
get_envfile "$TMPENV";

echo "Super=$SUPERDB";

VAL_COMP=$(get_val $COMP "$SUPERDB" "select key_sequence \
			from key_sequence \
			where table_name = 'portfolio_split' \
			and code_key = 'ext_ref_id'");
VAL_COMP=$(echo $VAL_COMP);
echo "Composer = $VAL_COMP";

VAL_WRAP=$(get_val $WRAP "sd_super" "select request_num from sd_next_request_num");
VAL_WRAP=$(echo $VAL_WRAP);
echo "Wrap     = $VAL_WRAP";

VAL=$(expr $VAL_COMP - $VAL_WRAP);
echo "Gap = $VAL";

do_finish
